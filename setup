#!/bin/bash

# Version     : 0.1
# Author      : J. Pfeffer
# License     : GPL

## Planned Features
# Allow 32-bit architecture (branches for Eclipse and PATH in run-eclipse, etc...)
# Eclipse headless import-all instead of import

## Variables ##
WORKSPACE_DIR="workspace"
ARCHITECTURE=`uname -m`

# Cleaning (true/false)
CLEANING=true

# Required packages ##
# Essential packages for builiding, java (for Eclipse) and wget to download resources
REQUIREMENTS="\
build-essential \
git \
openjdk-7-jre \
wget"

# Libraries to install
#REQUIREMENTS+=" libboost-all-dev"
#REQUIREMENTS+=" libsfml-dev"

# GitHub repos to clone and import into the workspace
# For automatic import, the project name should be the same as the repository name
# AS projects
GITHUB_REPOS=( "${GITHUB_REPOS[@]}" "MRT1-AS_00_Hallo" )

# C projects
GITHUB_REPOS=( "MRT1-C_00_Hallo" "MRT1-C_01_Datentypen" "MRT1-C_02_Identifier" "MRT1-C_03_Ausdruck" "MRT1-C_04_Flusskontrolle" "MRT1-C_05_Felder" "MRT1-C_06_Struct" "MRT1-C_07_Zeiger" "MRT1-C_08_Strukturzeiger")

# C++ projects
GITHUB_REPOS=( "${GITHUB_REPOS[@]}" "MRT1-CPP_00_Hallo")

# Eclipse package solution to install
ECLIPSE_PACKAGE="http://www.eclipse.org/downloads/download.php?file=/technology/epp/downloads/release/luna/SR2/eclipse-cpp-luna-SR2-linux-gtk-x86_64.tar.gz&r=1"

## Functions ##

function error () { 
 echo " Error: $@" ; 
}

function info () { 
 echo " Info: $@" ; 
}

function download()
{
    local url=$1
    local target=$2
    echo -n "    "
    wget --progress=dot $url -O $target 2>&1 | grep --line-buffered "%" | \
        sed -u -e "s,\.,,g" | awk '{printf("\b\b\b\b%4s", $2)}'
    echo -ne "\b\b\b\b"
    echo " DONE"
}

##### Welcome #####
echo "This script will install the MRT lecture programming environment for Raspberry Pi cross-compilation."
echo "It will download ~400 MB and use ~1.5GB disk space."
echo
read -p "Would you like to continue? (y/N) " -n 1 -r
echo    
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 0
fi

##### Some checks #####
# Check architecture
if [ $ARCHITECTURE != "x86_64" ]; then
    error "This script is only for the x86_64 architecture."
    exit 1
fi

# Check if Eclipse is running
if ps ax | grep eclipse.equinox | grep -v grep | grep -v $0 > /dev/null; then
    error "Eclipse is running! Please exit Eclipse!"
    exit 1
fi

##### Setup environment #####
# Set PATH variable
export PATH=$PATH:"$PWD/raspberrypi/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin"

# Install requirements
echo "Installing requirements ..."
sudo apt-get -q --show-progress install $REQUIREMENTS
echo " DONE"
echo ""

# Download eclipse
if [ -d "eclipse" ]; then
    info "The 'eclipse' folder already exists."
    echo ""
else
    echo "Downloading eclipse ..."
    download "$ECLIPSE_PACKAGE" eclipse.tar.gz
    echo "Extracting eclipse ..."
    tar -xzf eclipse.tar.gz
    rm -f eclipse.tar.gz
    echo " DONE"
    echo ""
fi

# Raspberry Pi cross-compilation tool chain
if [ -d "raspberrypi" ]; then
    info "The folder 'raspberrypi' already exists."
    echo ""
else
    echo "Cloning the Raspberry Pi tools repository. This may take a while, it is big (~200MB download, ~1GB afterwards) ..."
    mkdir raspberrypi
    git clone --depth=1 https://github.com/raspberrypi/tools.git raspberrypi/tools
    echo " DONE"
    echo ""
fi

# Create workspace
echo "Creating/updating MRT workspace ..."
if [ ! -d $WORKSPACE_DIR ]; then
    mkdir $WORKSPACE_DIR
fi

# Clone and import repositories
for REPO in "${GITHUB_REPOS[@]}" 
do
    echo " $REPO"
    if [ ! -d "$WORKSPACE_DIR/$REPO" ]; then
        git clone https://github.com/plt-tud/$REPO.git workspace/$REPO
        eclipse/eclipse -nosplash -data workspace -application org.eclipse.cdt.managedbuilder.core.headlessbuild -import $WORKSPACE_DIR/$REPO
    else
        git pull
    fi
done

echo " DONE"
echo ""

echo "+++++ INFO ++++"
echo "Start Eclipse with the command ./run-eclipse"
